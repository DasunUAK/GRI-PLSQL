SELECT 
T1.ORDER_NO as Order_No,
T0.DELIVER_TO_CUSTOMER_NO as Customer,
T0.SHIP_ADDR_NO as Del_Customer,
T0.SHIPMENT_ID as Shipment_No,
T2.VOLUME AS Volume,
T1.CF$_ITEM_TYPE as Item_Types,
T0.STATE as Status,
SUM(T1.CF$_C_NET_WEIGHT) as Weight,
SUM((T1.CF$_C_NET_WEIGHT/T1.SALES_QTY)*T1.QTY_PICKED) as Loaded_Weight,
SUM((T1.CF$_C_NET_WEIGHT/T1.SALES_QTY)*T1.QTY_SHIPPED) as Loaded_Weight_2,
T0.CF$_PRO_COMP_DATE AS PRO_COM_DATE,
(T0.CF$_PRO_COMP_DATE+2) AS PLANNED_SHIP_DATE,
SUM(T1.SALES_QTY) as Connected_Qty,SUM(T1.QTY_PICKED) as Picked_Qty,
Customer_Order_Delivery_API.Get_Actual_Shipment_Date(T0.SHIPMENT_ID)  AS LOADING_DATE,
T0.CF$_DE_METHOD_N as Container_Type,
T0.DELIVERY_TERMS as Term,
T0.cf$_C_Destination_Port as Location,
T3.CF$_CUSTOM_NAME as Name,
CASE WHEN (T0.STATE = 'Completed') then 'Loaded' else
          to_char(ROUND((SUM(T1.QTY_PICKED)*100)/SUM(T1.SALES_QTY)))end AS LOADING,
EXTRACT(Month FROM SYSDATE) as Current_Month,
CASE --WHEN (EXTRACT(Month FROM (T0.CF$_PRO_COMP_DATE+2))= EXTRACT(Month FROM SYSDATE)) then 5
WHEN (EXTRACT(Month FROM (T0.CF$_PRO_COMP_DATE+2)))=(EXTRACT(Month FROM T6.Next_Month))then 6
  else 4 end as Shipment_Month

FROM SHIPMENT_CFV T0
INNER JOIN SHIPMENT_ORDER_LINE_CFV T1 ON T0.SHIPMENT_ID = T1.shipment_id
LEFT JOIN
(
SELECT q.SHIPMENT_ID as SHIPMENT_ID,
CASE WHEN(q.CF$_DE_METHOD_N = '1x20 FCL')THEN ROUND(q.CF$_VOL_20_FT*100)
     WHEN(q.CF$_DE_METHOD_N = '1x40 FCL')THEN ROUND(q.CF$_VOL_40_FT*100)
     WHEN(q.CF$_DE_METHOD_N = '1x40 FCL HQ')THEN ROUND(q.CF$_VOL_40_FT_HQ*100) else 0 end as Volume
     
 FROM SHIPMENT_CFV q

)T2 ON T0.SHIPMENT_ID = T2.SHIPMENT_ID
INNER JOIN 
CUSTOMER_INFO_CFV T3 ON T0.DELIVER_TO_CUSTOMER_NO = T3.CUSTOMER_ID

INNER JOIN
(SELECT J0.shipment_id,ADD_MONTHS(SYSDATE,1) as Next_month  FROM 
SHIPMENT J0
GROUP BY J0.shipment_id)T6 ON T0.SHIPMENT_ID = T6.SHIPMENT_ID

WHERE T0.STATE not in ('Closed','Cancelled') 
AND T1.CF$_ITEM_TYPE = 'Solid'
GROUP BY
T1.ORDER_NO,T0.DELIVER_TO_CUSTOMER_NO,T0.SHIPMENT_ID,T1.CF$_ITEM_TYPE,T0.STATE,
T0.CF$_NET_WEIGHT,
T0.CF$_PRO_COMP_DATE,T0.CF$_LOADING_DATE,T0.CF$_DE_METHOD_N,T2.VOLUME,T0.DELIVERY_TERMS,T0.cf$_C_Destination_Port,
T3.CF$_CUSTOM_NAME,T0.CREATED_DATE,T6.Next_Month,T0.SHIP_ADDR_NO